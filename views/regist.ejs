<!DOCTYPE html>
<html lang="en">

  <head>
    <%- include("./head.ejs") %>
  </head>
  
  <body>
    <nav id="navbar-example2" class="navbar navbar-light px-3">
      <a class="navbar-brand" href="#">중고 거래</a>
      <ul class="nav nav-pills">
        <li class="nav-item">
        <a id="regist" class="nav-link">등록</a>
        </li>
        <li class="nav-item">
        <a class="nav-link">마이페이지</a>
        </li>
        <li class="nav-item dropdown">
        <a class="nav-link" href="/user/logout">로그아웃</a>
        </li>
      </ul>
    </nav>
      
    <form id="modal" enctype="multipart/form-data" action="/regist/commit" onsubmit="return check()" method="post">
      <div id="top" style="height:48px; width:100%; position: relative; line-height: 40px;">
        <div style="float: left; margin: auto 20px; width: 40px;height: 40px; cursor: pointer;" onclick="location.href='/'">
          <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
          </svg>
        </div>
        <h3 style="float: left; line-height: 40px;">글작성</h3>
        <input type="submit" id="submit" value="완료">
      </div>
      <input type="text" class="form-control" name="title" id="title" placeholder="제목*">
      <select class="form-select" name="category" id="category">
        <option value="" disabled selected hidden>카테고리</option>
        <option value="전자기기">전자기기</option>
        <option value="가전제품">가전제품</option>
        <option value="가구">가구</option>
        <option value="유아용품">유아용품</option>
        <option value="생활/가공식품">생활/가공식품</option>
        <option value="도서">도서</option>
        <option value="스포츠/레저">스포츠/레저</option>
        <option value="잡화">잡화</option>
        <option value="의류">의류</option>
        <option value="게임/취미">게임/취미</option>
        <option value="뷰미/미용">뷰티/미용</option>
        <option value="반려동물용품">반려동물용품</option>
        <option value="티켓/음반">티켓/음반</option>
        <option value="식물">식물</option>
        <option value="기타">기타</option>
        <option value="삽니다">삽니다</option>
      </select>
      <div id="location_wrap" >
        <select id="sido" class="form-select" name="si">
          <option value="" disabled selected hidden>시/도</option>
        </select>
        <select id="sigugun" class="form-select" name="gu">
          <option value="" disabled selected hidden>시/군/구</option>
        </select>
        <select id="dong" class="form-select" name="dong">
          <option value="" disabled selected hidden>읍/면/동</option>
        </select>
        <!-- <input type="text" class="form-control" id="location" name="location" style="width: 70%; height: 100%; padding : 0 auto; float: left;" readonly>
        <button type="button" id="call" class="btn btn-outline-secondary" style="width: 30%; height: 100%; padding : 3px">주소 불러오기</button> -->
      </div>
      <textarea  id="contents" name="contents" class="form-control" placeholder="내용을 입력하세요"></textarea>
      <input type="text" class="form-control" name="cost" id="cost" placeholder="가격(원)" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
      <div id="imagebox">
        <label for="images" style="float: left;">
          <div id="plus">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">
              <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
              <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/>
            </svg>
            <div id="count">0/10</div>
            <input type="file" id="images" name="images" accept="image/*" onchange="upload(this)" style="display: none;" multiple>
          </div>
        </label>
      </div>
    </form>
    <div id="map" style="display: none;"></div>
  </body>

</html>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=372aa56c63c5b99ad7c801903ffae038&libraries=services"></script>
<script src="js/hangjungdong.js"></script>
<script>

  $(document).on("click", ".delImg", function () {
    var dT = new DataTransfer();
    var id = $(this).parent().attr("id")
    var files = $("#images")[0].files
    for (var i = 0; i < files.length; i++) {
      if (id != files[i].lastModified) {
        dT.items.add(files[i])
      }
    }
    document.querySelector("#images").files = dT.files
    $("#" + id).remove()
    $("#count").text(dT.items.length + "/10")
    console.log(document.querySelector("#images").files)
  })

  function check() {
    var title = $("#title").val()
    var contents = $("#contents").val()
    var category = $("#category").val()
    // var loc = $("#location").val()
    var si = $("#sido").val()
    var gu = $("#sigugun").val()
    var dong = $("#dong").val()
    console.log(si, gu, dong)
    if (title.length == 0) {
      alert("제목을 입력해주세요.")
      return false
    }
    if (category == null) {
      alert("카테고리를 선택해주세요.")
      return false
    }
    if (si==null || gu==null || dong==null){
      alert("지역을 선택해주세요")
      return false
    }
    // if (loc.length == 0) {
    //   alert("주소를 입력해주세요")
    //   return false
    // }
  }

  var dT = new DataTransfer();
  function upload(files) {
    var file = files.files
    for (var i = 0; i < file.length; i++) {
      if (dT.items.length == 10) {
        alert("이미지가 10개를 초과하였습니다.")
        break
      }
      var src = URL.createObjectURL(file[i])
      var imgFile = $("#images")[0].files[i]
      dT.items.add(imgFile)
      $("#imagebox").append(
        `<div class="imgwrap" id=${imgFile.lastModified}>
          <img src=${src}>
          <div class="delImg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"  class="bi bi-dash-circle" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
            </svg>
          </div>
         </div>`
      )
    }
    document.querySelector("#images").files = dT.files
    $("#count").text(dT.items.length + "/10")
  }

  // var options = {
  //   enableHighAccuracy : true,
  //   timeout : 5000,
  //   maximumAge : 0
  // };
  // function error(err) {
  //   console.warn('ERROR(' + err.code + '): ' + err.message);
  // };

  // function success(pos) {
  //   var crd = pos.coords;
  //   var lat = crd.latitude;
  //   var lon = crd.longitude;
  //   var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
  //   mapOption = {
  //       center: new kakao.maps.LatLng(lat, lon), // 지도의 중심좌표
  //       level: 1 // 지도의 확대 레벨
  //   };  
  //   var map = new kakao.maps.Map(mapContainer, mapOption);
  //   var geocoder = new kakao.maps.services.Geocoder();
  //   function searchAddrFromCoords(coords, callback) {
  //     // 좌표로 행정동 주소 정보를 요청합니다
  //     geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);         
  //   }
  //   function displayCenterInfo(result, status) {
  //     if (status === kakao.maps.services.Status.OK) {

  //       for(var i = 0; i < result.length; i++) {
  //         // 행정동의 region_type 값은 'H' 이므로
  //         if (result[i].region_type === 'H') {
  //           $("#location").val(result[i].address_name)
  //           break;
  //         }
  //       }
  //     }    
  //   }
  //   searchAddrFromCoords(map.getCenter(), displayCenterInfo);
  // };

  // $("#call").click(function() {
  //   navigator.geolocation.getCurrentPosition(success, error, options);
  // })


  $(document).ready(function () {
    //sido option 추가
    $.each(hangjungdong.sido, function (idx, code) {
      //append를 이용하여 option 하위에 붙여넣음
      $('#sido').append(fn_option(code.sido, code.codeNm));
    });

    //sido 변경시 시군구 option 추가
    $('#sido').change(function () {
      $('#sigugun').show();
      $('#sigugun').empty();
      $('#dong').empty();
      $('#dong').prepend(fn_option('', '읍/면/동'));
      //option중 선택을 기본으로 선택
      $('#dong option:eq("")').attr({
        "selected" : "selected",
        "disabled" : "disabled",
        "hidden" : "hidden"
      });
      $('#sigugun').append(fn_option('', '시/군/구')); //
      $('#sigugun option:eq("")').attr({
        "selected" : "selected",
        "disabled" : "disabled",
        "hidden" : "hidden"
      });
      $.each(hangjungdong.sigugun, function (idx, code) {
        if ($('#sido > option:selected').hasClass(code.sido)){
          $('#sigugun').append(fn_option(code.sigugun, code.codeNm));
        }
      });

      //세종특별자치시 예외처리
      //옵션값을 읽어 비교
      if ($('#sido option:selected').attr("class") == '36') {
        $('#sigugun').hide();
        
        //index를 이용해서 selected 속성(attr)추가
        //기본 선택 옵션이 최상위로 index 0을 가짐
        $('#sigugun option:eq(1)').attr({
          "selected" : "selected",
          "disabled" : "disabled",
          "hidden" : "hidden"
        });
        //trigger를 이용해 change 실행
        $('#sigugun').trigger('change');
      }
    });

    //시군구 변경시 행정동 옵션추가
    $('#sigugun').change(function () {
      //option 제거
      $('#dong').empty();
      $.each(hangjungdong.dong, function (idx, code) {
        if ($('#sido > option:selected').hasClass(code.sido) && $('#sigugun > option:selected').hasClass(code.sigugun)){
          $('#dong').append(fn_option(code.dong, code.codeNm));
        }
      });
      //option의 맨앞에 추가
      $('#dong').prepend(fn_option('', '읍/면/동'));
      //option중 선택을 기본으로 선택
      $('#dong option:eq("")').attr({
        "selected" : "selected",
        "disabled" : "disabled",
        "hidden" : "hidden"
      });

    });

    $('#dong').change(function () {
      var sido = $('#sido option:selected').val();
      var sigugun = $('#sigugun option:selected').val();
      var dong = $('#dong option:selected').val();
      var dongCode = sido + sigugun + dong + '00';

    });
  });

  function fn_option(code, name) {
    return '<option value="'+name+'" class='+code+'>' + name + '</option>';
  }


</script>

<style>
  body{
    background-color: #f9f9f9;
  }
  #navbar-example2 {
    background-color: #FFFFFF;
  }

  .navbar-brand {
    margin-left: 50px;
  }

  .row {
    width: 60vw;
    margin: 0 auto;
    text-align: center;
  }

  .nav-link {
    cursor: pointer;
    padding: 0;
    margin: 0 10px
  }

  #modal {
    position: absolute;
    width: 550px;
    height: 836px;
    padding: 30px, 20px;
    text-align: center;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 3px;
    border: solid 1.5px black;
    margin-top: 25px;
    background-color: #FFFFFF;
  }

  #modal h2 { 
    margin:  30px;
  }

  #title{
    border-top: 1px solid #ced4da;
    z-index: 2;
  }

  #contents{
    height: 500px;
    resize: none;
  }
  .form-control, .form-select{
    border-top :none;
    border-left: none;
    border-right: none;
    border-radius: 0px;
  }
  #plus{
    margin-left: 10px;
    margin-top : 45px;
    width: 50px;
    height: 50px;
    background-color: #FFFFFF;
    border : 1px solid #ced4da;
    text-align: center;
    cursor: pointer;
  }
  .bi-arrow-left{
    vertical-align: middle;
  }
  #imagebox{
    overflow-x: auto;
    overflow-y: hidden;
    text-align: left; 
    white-space: nowrap;
    width: 100%;
    height: 104px;
  }

  .imgwrap{
    position : relative;
    width: 100px;
    height: 100px;
    margin-left: 10px;
    margin-top: 20px;
    border-top: 1px solid #ced4da;
    display: inline-block;
  }
  img{
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
  }
  .delImg{
    position : absolute;
    right : -5px;
    top : -5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    padding : 0;
    cursor: pointer;
    background-color: rgb(128, 128, 128)

  }
  .bi-dash-circle{
    position: absolute;
  }

  #submit{
    position : absolute;
    right : 10px;
    background-color: #FFFFFF;
    border : none;
    top :  10%;
    height: 80%;
    z-index: 1;
  }
  #sido, #sigugun, #dong{
    width: 33%;
    float: left;
  }
</style>